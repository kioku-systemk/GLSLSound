<html>
    <head>
        <script src="glslsound.js"></script>
        <script>
        var soundShader = (function () {/*
                        
#define pi2 6.283185307179586476925286766559
uniform float test;
// cheap and unrealistic distortion
float dist(float s, float d)
{
	return clamp(s * d, -1.0, 1.0);
}
vec2 dist(vec2 s, float d)
{
	return clamp(s * d, -1.0, 1.0);
}
// note number to frequency
float ntof(float n)
{
	return 440.0 * pow(2.0, (n - 69.0) / 12.0);
}

// quantize
float quan(float s, float c)
{
	return floor(s / c) * c;
}
// randomize
float nse(float x)
{
	return fract(sin(x * 110.082) * 19871.8972);
	//return fract(sin(x * 110.082) * 13485.8372);
}
// heavy 909-ish bassdrum
float kick(float tb, float time)
{
	tb = fract(tb / 4.0) * 0.5;
	float aa = 5.0;
	tb = sqrt(tb * aa) / aa;
	
	float amp = exp(max(tb - 0.15, 0.0) * -10.0);
	float v = sin(tb * 100.0 * pi2) * amp;
	v = dist(v, 4.0) * amp;
	v += nse(quan(tb, 0.001)) * nse(quan(tb, 0.00001)) * exp(tb * -20.0) * 2.5;
	return v;
}

// bad 909-ish open hihat
float hat(float tb)
{
	tb = fract(tb / 4.0) * 0.5;
	float aa = 4.0;
	//tb = sqrt(tb * aa) / aa;
	return nse(sin(tb * 4000.0) * 0.0001) * smoothstep(0.0, 0.01, tb - 0.25) * exp(tb * -5.0);
}

float gate1(float t)
{
	#define stp 0.0625
	float v;
	v = abs(t - 0.00 - 0.015) - 0.015;
	v = min(v, abs(t - stp*1. - 0.015) - 0.015);
	v = min(v, abs(t - stp*2. - 0.015) - 0.015);
	v = min(v, abs(t - stp*4. - 0.015) - 0.015);
	v = min(v, abs(t - stp*6. - 0.015) - 0.015);
	v = min(v, abs(t - stp*8. - 0.05) - 0.05);
	v = min(v, abs(t - stp*11. - 0.05) - 0.05);
	v = min(v, abs(t - stp*14. - 0.05) - 0.05);
	
	return smoothstep(0.001, 0.0, v);
}
            vec2 synth2(float tb, float time)
            {
                float f = time * pi2 * ntof(87.0 - 12.0 + mod(tb, 4.0));
                float v = dist(sin(f + sin(f * 0.5)), 5.0) * gate1(tb);
                
                return vec2(v);
            }

            vec2 myHihat(float tb) {
                return fract(sin(dot(vec2(tb) ,vec2(12.9898, 78.233))) * vec2(8758.5453)) * exp(-10.0 * tb);
            }

            vec2 mySynth3(float tb) {
                // air plane sound 
                return vec2( sin(6.2831 * 440.0 * tb) * exp(-3.0 * tb) );
            }
            vec2 myDrum(float tb) {
                return vec2(sin(6.2831 * 110.0 * tb) * exp(-1.0 * tb) );
            }
            // fragment shader
            vec2 mainSound(float time){
                // air plane sound 
                return vec2( sin(6.2831 * 440.0 * test * time) * exp(-3.0 * time) );

                // drumn sound
                //return vec2(sin(6.2831 * 80.0 * time) * exp(-2.0 * time) );
                
                // Hi-hat sound
                //return fract(sin(dot(vec2(time) ,vec2(12.9898, 78.233))) * vec2(8758.5453)) * exp(-10.0 * time);    
                
                
                vec2 wave = vec2(0.0);
                float tb;

                //tb = mod(time * 3.0, 12.0);
                //wave += synth2(tb, time);

                
                //tb = mod(time, 1.0);
                //wave += myHihat(tb);
                
                for (int b = 1; b < 4; ++b) {
                    tb = mod(time - 0.25 * float(b), 1.0);
                    wave += myHihat(tb) * 1.0 / float(b) / float(b);
                }
                
                return wave;
            }
        */}).toString().match(/\n([\s\S]*)\n/)[1];

        window.onload = function () {
            sound = new GLSLSound();
            sound.setGain(0.5);
            var cr = sound.compleShader(soundShader);
            if (!cr) {
                var msg = document.createTextNode('Compile failed:' + sound.getError());
                document.body.appendChild(msg);
            } else { 
                sound.setUniform1f("test", 2.0, 3.0, 0.0, 4.0);
                sound.prepare(5.0); // 5.0[sec] sound
                sound.setEndCallback(function () {
                    console.log('play end');
                })

                var button = document.createElement('button');
                document.body.appendChild(button);
                button.innerHTML = "play GLSL";
                button.addEventListener('click', function () {
                    sound.play();
                });
            }
        }
        </script>
    </head>
<body>
</body>
</html>